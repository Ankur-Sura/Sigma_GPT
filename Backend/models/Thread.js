// =============================================================================
//                     THREAD MODEL - MongoDB Schema
// =============================================================================
/**
 * ðŸ“š WHAT IS THIS FILE?
 * ---------------------
 * Defines the MongoDB schema for chat threads using Mongoose.
 * 
 * ðŸ“Œ WHAT IS A SCHEMA?
 * --------------------
 * Schema = Blueprint for documents in a collection
 * - Defines fields and their types
 * - Adds validation rules
 * - Sets default values
 * 
 * ðŸ“Œ MONGOOSE vs RAW MONGODB:
 * ---------------------------
 * Raw MongoDB: db.threads.insertOne({anything: "goes"})
 * Mongoose: Validates data, provides methods, adds structure
 * 
 * ðŸ“Œ INTERVIEW TIP:
 * -----------------
 * "I use Mongoose for schema validation and ODM features. Each Thread
 *  document contains an array of messages, making it efficient to
 *  load entire conversations in one query."
 */

import mongoose from "mongoose";
// ðŸ“– Mongoose: ODM (Object Document Mapper) for MongoDB
// Like an ORM, but for document databases


// =============================================================================
//                         MESSAGE SUB-SCHEMA
// =============================================================================
/**
 * ðŸ“– Embedded Schema for Individual Messages
 * ------------------------------------------
 * Each message in a thread has:
 * - role: "user" or "assistant"
 * - content: The message text
 * - timestamp: When it was sent
 * 
 * ðŸ“Œ WHY EMBEDDED vs REFERENCED?
 * - Embedded: Messages stored inside Thread document
 * - Referenced: Messages in separate collection with foreign key
 * 
 * I chose Embedded because:
 * 1. Always load messages with thread (no extra query)
 * 2. Atomic updates (add message = one write)
 * 3. Good for bounded arrays (chat history)
 */

const MessageSchema = new mongoose.Schema({
    role: {
        type: String,
        enum: ["user", "assistant"],
        // ðŸ“– enum: Only allow these values
        // ðŸ“Œ Validation: Rejects "system", "bot", etc.
        required: true
    },
    content: {
        type: String,
        required: true
        // ðŸ“– required: Cannot save without this field
    },
    timestamp: {
        type: Date,
        default: Date.now
        // ðŸ“– default: Auto-set to current time if not provided
    }
});


// =============================================================================
//                         THREAD SCHEMA
// =============================================================================
/**
 * ðŸ“– Main Schema for Chat Threads
 * --------------------------------
 * A Thread represents one conversation (like a ChatGPT chat).
 * 
 * Fields:
 * - threadId: UUID (unique identifier from frontend)
 * - title: Display name in sidebar (first message)
 * - messages: Array of Message subdocuments
 * - createdAt: When thread was created
 * - updatedAt: Last activity (for sorting)
 * 
 * ðŸ“Œ WHY threadId vs _id?
 * - _id: MongoDB's auto-generated ObjectId
 * - threadId: UUID generated by frontend
 * 
 * Using frontend UUID allows:
 * 1. Create thread before first save
 * 2. Client knows ID immediately
 * 3. Works offline then syncs
 */

const ThreadSchema = new mongoose.Schema({
    threadId: {
        type: String,
        required: true,
        unique: true
        // ðŸ“– unique: Creates index, prevents duplicates
        // ðŸ“Œ MongoDB will reject duplicate threadId
    },
    title: {
        type: String,
        default: "New Chat"
        // ðŸ“– Usually set to first message content
    },
    messages: [MessageSchema],
    // ðŸ“– Array of embedded Message subdocuments
    // ðŸ“Œ Accessed as: thread.messages[0].content
    
    createdAt: {
        type: Date,
        default: Date.now
    },
    updatedAt: {
        type: Date,
        default: Date.now
        // ðŸ“– Updated manually when messages added
        // Used for sorting: most recent at top
    }
});


// =============================================================================
//                         EXPORT MODEL
// =============================================================================

export default mongoose.model("Thread", ThreadSchema);
// ðŸ“– mongoose.model("Thread", ThreadSchema)
// - "Thread": Model name (used for collection: "threads")
// - ThreadSchema: The schema definition
// 
// ðŸ“Œ USAGE:
// import Thread from "./models/Thread.js"
// const thread = new Thread({...})
// await thread.save()
// await Thread.find({})
// await Thread.findOne({threadId})


// =============================================================================
//                         SUMMARY FOR INTERVIEWS
// =============================================================================
/**
 * ðŸ“Œ SCHEMA DESIGN CHOICES:
 * 
 * 1. EMBEDDED MESSAGES:
 *    - Messages stored in Thread document
 *    - One query loads entire chat
 *    - Good for bounded data (chat history)
 * 
 * 2. FRONTEND UUID (threadId):
 *    - Client generates ID
 *    - Thread exists before first save
 *    - Enables optimistic UI updates
 * 
 * 3. TIMESTAMPS:
 *    - createdAt: For analytics, sorting by age
 *    - updatedAt: For "recent chats" sorting
 * 
 * ðŸ“Œ MONGOOSE FEATURES USED:
 * - Schema validation (required, enum)
 * - Default values
 * - Unique index
 * - Subdocuments (embedded schema)
 * 
 * ðŸ“Œ MONGODB COLLECTION:
 * Model "Thread" â†’ Collection "threads" (lowercased, pluralized)
 */